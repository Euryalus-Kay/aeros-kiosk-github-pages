<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aeros Racing F1 Jiosk - Updated Version</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: #f32411;
            color: #FFFFFF;
            height: 100vh;
            overflow: hidden;
            position: relative;
        }
        
        body.production {
            cursor: none;
        }
        
        h1, h2, h3 {
            font-family: 'Arial', sans-serif;
            text-transform: uppercase;
            font-weight: 900;
        }
        
        /* Background pattern */
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                radial-gradient(circle at 20% 50%, rgba(255,255,255,0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(0,0,0,0.1) 0%, transparent 50%);
            pointer-events: none;
        }
        
        /* Main container */
        .container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 1;
        }
        
        /* Header */
        .header {
            padding: 2rem;
            text-align: center;
            background: rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
            animation: fadeInDown 0.8s ease-out;
            display: block !important;
            opacity: 1;
            visibility: visible;
            transition: opacity 0.3s ease;
        }
        
        body.pdf-viewing .header {
            display: none !important;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }
        
        body.pdf-viewing .pdf-header-bar {
            display: none !important;
            opacity: 0 !important;
            visibility: hidden !important;
        }
        
        body.pdf-viewing .scroll-indicator {
            display: none !important;
            opacity: 0 !important;
            visibility: hidden !important;
        }
        
        /* Make PDF viewer truly full screen */
        body.pdf-viewing .pdf-content {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            z-index: 9999 !important;
        }
        
        body.pdf-viewing .pdf-viewer-container {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            padding: 0 !important;
            margin: 0 !important;
        }
        
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .logo {
            font-size: 3rem;
            letter-spacing: 0.2em;
            text-shadow: 0 5px 20px rgba(0,0,0,0.3);
            margin-bottom: 0.5rem;
        }
        
        .subtitle {
            font-family: 'Arial', sans-serif;
            font-size: 1.25rem;
            font-weight: 900;
            letter-spacing: 0.4em;
            text-transform: uppercase;
            color: #FFFFFF;
            text-shadow: 
                2px 2px 4px rgba(0,0,0,0.9),
                0 0 20px rgba(0,0,0,0.8),
                0 0 40px rgba(0,0,0,0.6);
            margin: 0;
            margin-top: -0.5rem;
        }
        
        /* Content area */
        .content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            position: relative;
            width: 100%;
            height: 100%;
        }
        
        /* Home state */
        .home-content {
            text-align: center;
            opacity: 1;
            transform: scale(1);
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }
        
        .home-content.hiding {
            opacity: 0;
            transform: scale(0.95) rotateX(10deg);
        }
        
        .tap-instruction {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(20px);
            padding: 3rem 5rem;
            border-radius: 30px;
            border: 2px solid rgba(255,255,255,0.2);
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            animation: fadeInScale 0.8s ease-out 0.2s both;
        }
        
        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        .tap-instruction:hover {
            transform: translateY(-5px);
            box-shadow: 0 25px 70px rgba(0,0,0,0.3);
        }
        
        .tap-instruction h2 {
            font-size: 3.5rem;
            letter-spacing: 0.1em;
            margin-bottom: 1rem;
        }
        
        .tap-instruction p {
            font-size: 1.2rem;
            opacity: 0.8;
        }
        
        /* PDF state */
        .pdf-content {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: none;
            background: #000000;
            overflow: hidden;
            opacity: 0;
            transform: translateY(50px);
        }
        
        .pdf-content.showing {
            display: block;
            animation: slideUpFade 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }
        
        @keyframes slideUpFade {
            0% {
                opacity: 0;
                transform: translateY(100px) scale(0.9) perspective(1000px) rotateX(-10deg);
            }
            70% {
                opacity: 1;
                transform: translateY(-15px) scale(1.02) perspective(1000px) rotateX(2deg);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1) perspective(1000px) rotateX(0deg);
            }
        }
        
        /* PDF Header */
        .pdf-header-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 1.5rem 3rem;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0) 100%);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.4s ease 0.3s;
        }
        
        .pdf-content.showing .pdf-header-bar {
            opacity: 1;
            transform: translateY(0);
        }
        
        .pdf-title {
            font-size: 1.75rem;
            letter-spacing: 0.05em;
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
            font-weight: 700;
        }
        
        .home-btn {
            background: rgba(255,255,255,0.15);
            border: 2px solid rgba(255,255,255,0.25);
            color: white;
            padding: 0.75rem 2rem;
            border-radius: 50px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            overflow: hidden;
            position: relative;
        }
        
        .home-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -150%;
            width: 150%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: left 0.5s ease;
            transform: skewX(-25deg);
        }
        
        .home-btn:hover {
            background: rgba(255,255,255,0.25);
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            border-color: rgba(255,255,255,0.4);
        }
        
        .home-btn:hover::before {
            left: 150%;
        }
        
        .home-btn:active {
            transform: translateY(0) scale(0.98);
        }
        
        /* Scroll Indicator - COMPACT SIZE */
        .scroll-indicator {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 500;
            text-align: center;
            display: none;
            opacity: 0;
            transition: opacity 0.5s ease;
            pointer-events: none;
            background: rgba(0,0,0,0.9);
            padding: 0.8rem 1.5rem;
            border-radius: 25px;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255,255,255,0.8);
            box-shadow: 0 5px 25px rgba(0,0,0,0.9);
        }
        
        .pdf-content.showing .scroll-indicator {
            display: block !important;
        }
        
        .scroll-indicator.hidden {
            opacity: 0 !important;
        }
        
        .scroll-text {
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: white;
            font-weight: 600;
            text-shadow: 0 2px 5px rgba(0,0,0,1);
            font-family: 'Arial', sans-serif;
            margin: 0;
            white-space: nowrap;
        }
        
        /* PDF Frame - Completely clean, no UI elements */
        .pdf-viewer-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: white !important;
            background-color: white !important;
            padding: 0;
            margin: 0;
            box-sizing: border-box;
            overflow: hidden !important;
        }
        
        .pdf-frame-wrapper {
            width: 100%;
            height: 100%;
            background: white !important;
            overflow: hidden !important;
            position: relative;
            border: none !important;
            outline: none !important;
            box-shadow: none !important;
            transform: none !important;
            -webkit-overflow-scrolling: touch;
            margin: 0;
            padding: 0;
            /* Clip the iframe to hide scrollbar */
            clip-path: inset(0 0 0 0);
        }
        
        .pdf-frame {
            position: absolute;
            top: 0;
            left: 0;
            right: -20px;
            bottom: 0;
            width: calc(100% + 20px);
            height: 100%;
            border: 0 !important;
            outline: 0 !important;
            background: white !important;
            overflow: auto !important;
            display: block;
            box-shadow: none !important;
            -webkit-appearance: none !important;
            -moz-appearance: none !important;
            appearance: none !important;
            background-color: white !important;
            background-image: none !important;
            transform: translateZ(0);
            will-change: transform;
            z-index: 2;
            -ms-overflow-style: none !important;
            scrollbar-width: none !important;
            margin: 0;
            padding: 0;
            /* Center and maximize PDF content */
            object-fit: contain;
            object-position: center;
        }
        
        /* Enhanced iframe scrollbar hiding */
        .pdf-frame::-webkit-scrollbar {
            display: none !important;
            width: 0 !important;
            height: 0 !important;
        }
        
        .pdf-frame::-webkit-scrollbar-track {
            display: none !important;
        }
        
        .pdf-frame::-webkit-scrollbar-thumb {
            display: none !important;
        }
        
        .pdf-frame::-webkit-scrollbar-corner {
            display: none !important;
        }
        
        /* Force hide scrollbars on all iframe elements */
        iframe {
            border: 0 !important;
            outline: none !important;
            overflow: auto !important;
            -webkit-overflow-scrolling: touch !important;
            margin: 0 !important;
            padding: 0 !important;
            -ms-overflow-style: none !important;
            scrollbar-width: none !important;
        }
        
        /* Hide PDF viewer toolbar and UI elements */
        .pdf-frame {
            /* Hide Adobe PDF toolbar */
            -webkit-transform: scale(1.0) !important;
            transform: scale(1.0) !important;
        }
        
        /* Force hide any PDF viewer UI */
        body.pdf-viewing .pdf-frame {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            z-index: 9999 !important;
            border: none !important;
            margin: 0 !important;
            padding: 0 !important;
            transform: none !important;
        }
        
        body.pdf-viewing .pdf-frame-wrapper {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            padding: 0 !important;
            margin: 0 !important;
            border: none !important;
        }
        
        iframe::-webkit-scrollbar {
            display: none !important;
            width: 0 !important;
            height: 0 !important;
        }
        
        iframe::-webkit-scrollbar-track {
            display: none !important;
        }
        
        iframe::-webkit-scrollbar-thumb {
            display: none !important;
        }
        
        iframe::-webkit-scrollbar-corner {
            display: none !important;
        }
        
        
        /* Developer panel */
        .dev-panel {
            position: fixed;
            top: 0;
            left: -400px;
            width: 400px;
            height: 100vh;
            background: #1a1a1a;
            transition: left 0.3s;
            z-index: 1000;
            overflow-y: auto;
            box-shadow: 5px 0 20px rgba(0,0,0,0.3);
        }
        
        .dev-panel.open {
            left: 0;
        }
        
        .dev-toggle {
            position: fixed;
            top: 1rem;
            left: 1rem;
            background: rgba(0,0,0,0.5);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            z-index: 999;
            font-size: 0.875rem;
            backdrop-filter: blur(10px);
        }
        
        .dev-toggle.production-mode {
            display: none;
        }
        
        .dev-header {
            padding: 2rem;
            border-bottom: 2px solid #f32411;
        }
        
        .dev-section {
            padding: 1.5rem;
            border-bottom: 1px solid #333;
        }
        
        .dev-section h3 {
            color: #f32411;
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }
        
        input, select {
            width: 100%;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: rgba(255,255,255,0.1);
            border: 1px solid #333;
            color: white;
            border-radius: 5px;
        }
        
        .btn {
            width: 100%;
            padding: 0.75rem;
            background: #f32411;
            border: none;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            text-transform: uppercase;
            margin-top: 0.5rem;
        }
        
        .btn:hover {
            background: #d91e0c;
        }
        
        .btn-danger {
            background: #dc3545;
        }
        
        .card-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: rgba(255,255,255,0.05);
            border-radius: 5px;
            margin-bottom: 0.5rem;
        }
        
        .card-id {
            font-family: monospace;
            color: #4CAF50;
            font-size: 0.9rem;
        }
        
        /* Status bar */
        .status-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.8);
            padding: 0.75rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.875rem;
            z-index: 100;
            backdrop-filter: blur(10px);
        }
        
        .status-bar.production-mode {
            display: none;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #dc3545;
        }
        
        .status-dot.connected {
            background: #4CAF50;
        }
        
        /* Transition overlay */
        .transition-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #f32411;
            z-index: 3000;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .transition-overlay.active {
            display: block;
            opacity: 1;
        }
        
        .transition-overlay .loading-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            animation: loadingPulse 1s ease-in-out infinite;
        }
        
        @keyframes loadingPulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.05); }
        }
        
        .loading-spinner {
            width: 80px;
            height: 80px;
            border: 3px solid rgba(255,255,255,0.1);
            border-top-color: white;
            border-right-color: white;
            border-radius: 50%;
            animation: spin 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55) infinite;
            margin: 0 auto 1.5rem;
            box-shadow: 0 0 40px rgba(255,255,255,0.3);
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 1.3rem;
            font-weight: 700;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            opacity: 0;
            animation: fadeInUp 0.5s ease-out 0.2s forwards;
            color: white;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 0.9;
                transform: translateY(0);
            }
        }
        
        /* Clean PDF viewing - adjusted to not hide header permanently */
        body.pdf-viewing .status-bar {
            display: none;
        }
        
        body.pdf-viewing .content {
            padding: 0;
        }
        
        /* Force full-screen PDF with no gaps */
        body.pdf-viewing {
            overflow: hidden !important;
        }
        
        body.pdf-viewing * {
            -webkit-overflow-scrolling: touch !important;
        }
        
        /* Force black on PDF container elements */
        .pdf-content {
            background: #000000 !important;
        }
        
        .pdf-viewer-container {
            background: #000000 !important;
        }
        
        .pdf-frame-wrapper {
            background: #000000 !important;
        }
        
        .pdf-frame {
            background-color: #000000 !important;
            background: #000000 !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1 class="logo">AEROS RACING</h1>
            <p class="subtitle">AEROS PIT KIOSK</p>
        </div>
        
        <!-- Content -->
        <div class="content">
            <!-- Home State -->
            <div class="home-content" id="homeContent" style="display: flex;">
                <div class="tap-instruction">
                    <h2>DISCOVER OUR ENTERPRISE</h2>
                    <p>Grab A Red RFID Card From The Enterprise Wall And Tap On The Sticker To Learn More About Our Marketing Materials.</p>
                </div>
            </div>
            
            <!-- PDF State - AGGRESSIVE FULL SCREEN -->
            <div class="pdf-content" id="pdfContent" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #000000; z-index: 99999;">
                <embed 
                    id="pdfEmbed"
                    type="application/pdf"
                    style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90vw; height: 90vh; border: none; background: #000000;">
                </embed>
            </div>
        </div>
    </div>
    
    <!-- Developer Toggle -->
    <button class="dev-toggle" id="devToggle" onclick="toggleDev()">☰</button>
    
    <!-- Developer Panel -->
    <div class="dev-panel" id="devPanel">
        <div class="dev-header">
            <h2>Developer Settings</h2>
            <button class="btn" onclick="toggleDev()">Close</button>
        </div>
        
        <div class="dev-section">
            <h3>Add Card</h3>
            <input type="text" id="cardId" placeholder="Card ID">
            <input type="text" id="docName" placeholder="Document Name">
            <select id="pdfSelect">
                <option value="">Select PDF</option>
            </select>
            <br><br>
            <button class="btn" onclick="loadPDFs()" style="margin-right: 0.5rem; background: #28a745;">🔄 Refresh PDFs</button>
            <button class="btn" onclick="addCard()">Add Card</button>
        </div>
        
        <div class="dev-section">
            <h3>Add PDF</h3>
            <input type="file" id="pdfFile" accept=".pdf" style="margin-bottom: 1rem;">
            <button class="btn" onclick="uploadPDF()">Upload PDF</button>
            <div id="uploadStatus" style="margin-top: 0.5rem; font-size: 0.9rem;"></div>
        </div>
        
        <div class="dev-section">
            <h3>GitHub Repository</h3>
            <p style="margin-bottom: 1rem; opacity: 0.8;">
                ✅ Configured: <strong>Euryalus-Kay/aeros-kiosk-github-pages</strong><br>
                📁 PDFs loaded from: <code>pdfs/</code> folder<br>
                🔄 Uploads commit to: <code>main</code> branch<br>
                🔑 Token: <strong>PERMANENTLY SET</strong> - Uploads will commit to GitHub
            </p>
        </div>
        
        <div class="dev-section">
            <h3>Card Mappings</h3>
            <div id="cardList"></div>
        </div>
        
        <div class="dev-section">
            <h3>System Mode</h3>
            <p style="margin-bottom: 1rem; opacity: 0.7;">
                Production mode is permanent!
            </p>
            <button class="btn btn-danger" onclick="switchToProduction()">
                Switch to Production
            </button>
        </div>
    </div>
    
    <!-- Status Bar -->
    <div class="status-bar" id="statusBar">
        <div class="status-item">
            <span>Mode:</span>
            <strong id="modeText">Developer</strong>
        </div>
        <div class="status-item">
            <div class="status-dot" id="statusDot"></div>
            <span id="statusText">Disconnected</span>
        </div>
    </div>
    
    <!-- Transition Overlay -->
    <div class="transition-overlay" id="transitionOverlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text">Loading Document</div>
        </div>
    </div>
    
    <script>
        // State
        let config = { mode: 'developer', cards: {}, github: { owner: 'Euryalus-Kay', repo: 'aeros-kiosk-github-pages', branch: 'main', token: atob('Z2hwX2lrU29PdVNYcEVYNG5kUDlhbFhJb1llMDFBN3VERDFOeE5GUgo=').trim() } };
        let rfidBuffer = '';
        let resetTimer = null;
        let scrollIndicatorTimer = null;
        
        // PERMANENT CARD MAPPINGS - Never disappear!
        const sampleCards = {
            'DEV001': { name: 'Developer Manual', pdf: 'sample1.pdf' },
            'TEST001': { name: 'Test Document', pdf: 'sample2.pdf' },
            'USER001': { name: 'User Guide', pdf: 'manual.pdf' },
            // Your actual RFID numbers - PERMANENTLY SET
            '2650964535': { name: 'greeting cards', pdf: 'GC.pdf' },
            '2653423431': { name: 'Greeting Cards', pdf: 'GC.pdf' },
            '2658357303': { name: 'Gummies', pdf: 'gummies.pdf' },
            '2662250807': { name: 'Card 2662250807', pdf: 'sample2.pdf' },
            '2823882614': { name: 'Spark Shop', pdf: 'sparkshop.pdf' },
            '2829600102': { name: 'Team Apparel', pdf: 'TA.pdf' },
            '2831102582': { name: 'Card 2831102582', pdf: 'sample1.pdf' },
            '2834398566': { name: 'Vinyl Bags', pdf: 'Vinyl Bags.pdf' }
        };
        
        // Scroll monitoring removed - completely clean PDF view
        
        // Initialize
        function init() {
            console.log('🚀 Starting Aeros Racing Jiosk... v2.1');
            
            // Load persistent data from localStorage
            loadPersistentData();
            
            // ALWAYS ensure permanent card mappings are loaded (permanent mappings take priority)
            console.log('🔧 Before merge - config.cards:', Object.keys(config.cards));
            console.log('🔧 Before merge - sampleCards:', Object.keys(sampleCards));
            config.cards = { ...config.cards, ...sampleCards };
            console.log('🔧 After merge - config.cards:', Object.keys(config.cards));
            console.log('🔧 Checking specific card 2823882614:', config.cards['2823882614']);
            
            // Update UI
            updateUI();
            updateCardList();
            
            // RFID input handler
            document.addEventListener('keypress', (e) => {
                // Only listen on home screen
                if (document.getElementById('pdfContent').style.display === 'block') return;
                
                if (e.key === 'Enter') {
                    if (rfidBuffer) {
                        console.log('🏷️  RFID:', rfidBuffer);
                        handleCardScan(rfidBuffer);
                        rfidBuffer = '';
                    }
                } else {
                    rfidBuffer += e.key;
                }
            });
            
            // Load PDFs
            loadPDFs();
        }
        
        // Persistent storage functions
        function savePersistentData() {
            try {
                // Only save cards and mode (GitHub settings are permanently hardcoded)
                const dataToSave = {
                    cards: config.cards,
                    mode: config.mode
                };
                localStorage.setItem('aerosConfig', JSON.stringify(dataToSave));
                localStorage.setItem('aerosUploadedPDFs', JSON.stringify(window.uploadedPDFs || {}));
                console.log('💾 Data saved to localStorage');
            } catch (error) {
                console.error('Failed to save data:', error);
            }
        }
        
        function loadPersistentData() {
            try {
                // Load config
                const savedConfig = localStorage.getItem('aerosConfig');
                if (savedConfig) {
                    const parsed = JSON.parse(savedConfig);
                    // Keep hardcoded GitHub settings, only load cards and mode
                    config.cards = parsed.cards || { ...sampleCards };
                    config.mode = parsed.mode || 'developer';
                    console.log('📂 Loaded config from localStorage');
                } else {
                    // Load sample data if no saved config
                    config.cards = { ...sampleCards };
                }
                
                // Load uploaded PDFs
                const savedPDFs = localStorage.getItem('aerosUploadedPDFs');
                if (savedPDFs) {
                    window.uploadedPDFs = JSON.parse(savedPDFs);
                    console.log('📂 Loaded uploaded PDFs from localStorage');
                } else {
                    window.uploadedPDFs = {};
                }
            } catch (error) {
                console.error('Failed to load data:', error);
                // Fallback to sample data
                config.cards = { ...sampleCards };
                window.uploadedPDFs = {};
            }
        }
        
        // Handle card scan
        function handleCardScan(cardId) {
            console.log('🔍 Looking up card:', cardId);
            console.log('🔍 Card ID type:', typeof cardId);
            console.log('🔍 Card ID length:', cardId.length);
            console.log('🔍 Available cards:', Object.keys(config.cards));
            
            if (config.cards[cardId]) {
                const card = config.cards[cardId];
                console.log('✅ Found card mapping:', card);
                showPDF(card.name, card.pdf);
            } else {
                console.log('❌ Unknown card:', cardId);
                console.log('❌ Checking for similar cards...');
                // Check if there's a similar card ID
                for (let key in config.cards) {
                    if (key.includes(cardId) || cardId.includes(key)) {
                        console.log('🔍 Similar card found:', key, '→', config.cards[key]);
                    }
                }
                if (config.mode === 'developer') {
                    alert(`Unknown card: ${cardId}\nAdd it in developer settings.`);
                }
            }
        }
        
        // UI Functions
        function getPdfUrl(file) {
            // Simple direct URL construction for GitHub Pages with toolbar hiding, centering, and black background
            const baseUrl = location.origin + location.pathname.replace(/[^/]*$/, '');
            const timestamp = Date.now();
            const pdfUrl = `${baseUrl}pdfs/${file}?t=${timestamp}#toolbar=0&navpanes=0&scrollbar=0&statusbar=0&messages=0&view=FitH&zoom=100`;
            console.log('📄 PDF URL with centering:', pdfUrl);
            return pdfUrl;
        }

        function showPDF(name, file) {
            // First, start the transition
            const homeContent = document.getElementById('homeContent');
            const pdfContent = document.getElementById('pdfContent');
            const overlay = document.getElementById('transitionOverlay');
            const scrollIndicator = document.getElementById('scrollIndicator');
            
            // Hide home content with animation
            homeContent.classList.add('hiding');
            
            // Show loading overlay with delay for smooth transition
            setTimeout(() => {
                overlay.classList.add('active');
            }, 150);
            
            // Prepare PDF
            setTimeout(() => {
                // Get PDF URL directly
                let pdfUrl;
                if (window.uploadedPDFs && window.uploadedPDFs[file]) {
                    pdfUrl = window.uploadedPDFs[file];
                } else {
                    pdfUrl = getPdfUrl(file);
                }
                
                const embed = document.getElementById('pdfEmbed');
                
                // Load PDF directly with embed
                console.log('📄 Loading PDF with embed:', pdfUrl);
                embed.src = pdfUrl;
                
                // Show PDF content with animation - AGGRESSIVE
                homeContent.style.display = 'none';
                homeContent.classList.remove('hiding');
                pdfContent.style.display = 'block';
                pdfContent.style.position = 'fixed';
                pdfContent.style.top = '0';
                pdfContent.style.left = '0';
                pdfContent.style.width = '100vw';
                pdfContent.style.height = '100vh';
                pdfContent.style.background = '#000000';
                pdfContent.style.zIndex = '99999';
                
                // Wait for embed to start loading - AGGRESSIVE
                embed.onload = function() {
                    setTimeout(() => {
                        overlay.classList.remove('active');
                        pdfContent.classList.add('showing');
                        document.body.classList.add('pdf-viewing');
                        // FORCE CENTER THE EMBED
                        embed.style.position = 'absolute';
                        embed.style.top = '50%';
                        embed.style.left = '50%';
                        embed.style.transform = 'translate(-50%, -50%)';
                        embed.style.width = '90vw';
                        embed.style.height = '90vh';
                        embed.style.border = 'none';
                        embed.style.background = '#000000';
                    }, 200);
                };
                
                // Fallback if onload doesn't fire - AGGRESSIVE
                setTimeout(() => {
                    overlay.classList.remove('active');
                    pdfContent.classList.add('showing');
                    document.body.classList.add('pdf-viewing');
                    // FORCE CENTER THE EMBED
                    embed.style.position = 'absolute';
                    embed.style.top = '50%';
                    embed.style.left = '50%';
                    embed.style.transform = 'translate(-50%, -50%)';
                    embed.style.width = '90vw';
                    embed.style.height = '90vh';
                    embed.style.border = 'none';
                    embed.style.background = '#000000';
                }, 1000);
                
            }, 400);
            
            // Start reset timer
            clearTimeout(resetTimer);
            resetTimer = setTimeout(goHome, 16000);
        }
        
        function goHome() {
            console.log('Going home...');
            const homeContent = document.getElementById('homeContent');
            const pdfContent = document.getElementById('pdfContent');
            const header = document.querySelector('.header');
            
            // Remove showing class to trigger exit animation
            pdfContent.classList.remove('showing');
            
            // Remove pdf-viewing class to show header again
            document.body.classList.remove('pdf-viewing');
            
            setTimeout(() => {
                homeContent.style.display = 'flex';
                pdfContent.style.display = 'none';
                document.getElementById('pdfEmbed').src = '';
                
                // Ensure header is visible
                if (header) {
                    header.style.display = 'block';
                    header.style.opacity = '1';
                    header.style.visibility = 'visible';
                }
            }, 400);
            
            clearTimeout(resetTimer);
        }
        
        function toggleDev() {
            if (config.mode === 'production') return;
            
            const panel = document.getElementById('devPanel');
            panel.classList.toggle('open');
        }
        
        function updateUI() {
            document.getElementById('modeText').textContent = 
                config.mode.charAt(0).toUpperCase() + config.mode.slice(1);
            
            if (config.mode === 'production') {
                document.body.classList.add('production');
                document.getElementById('devToggle').classList.add('production-mode');
                document.getElementById('statusBar').classList.add('production-mode');
                document.getElementById('devPanel').classList.remove('open');
            }
            
            updateCardList();
        }

        // Token is permanently set in config - no UI needed
        
        function updateCardList() {
            const list = document.getElementById('cardList');
            list.innerHTML = '';
            
            Object.entries(config.cards).forEach(([cardId, card]) => {
                const item = document.createElement('div');
                item.className = 'card-item';
                item.innerHTML = `
                    <div>
                        <div class="card-id">${cardId}</div>
                        <div>${card.name}</div>
                    </div>
                    <button onclick="removeCard('${cardId}')" style="
                        background: #dc3545;
                        border: none;
                        color: white;
                        padding: 0.25rem 0.75rem;
                        border-radius: 3px;
                        cursor: pointer;
                    ">Remove</button>
                `;
                list.appendChild(item);
            });
        }
        
        // Card Management
        function addCard() {
            const cardId = document.getElementById('cardId').value.trim();
            const name = document.getElementById('docName').value.trim();
            const pdf = document.getElementById('pdfSelect').value;
            
            if (!cardId || !name || !pdf) {
                alert('Please fill all fields');
                return;
            }
            
            config.cards[cardId] = { name, pdf };
            
            document.getElementById('cardId').value = '';
            document.getElementById('docName').value = '';
            document.getElementById('pdfSelect').value = '';
            
            updateCardList();
            savePersistentData(); // Save after adding card
        }
        
        function removeCard(cardId) {
            if (!confirm('Remove this card?')) return;
            delete config.cards[cardId];
            updateCardList();
            savePersistentData(); // Save after removing card
        }
        
        async function loadPDFs() {
            const select = document.getElementById('pdfSelect');
            
            // FORCE CLEAR AND REBUILD
            select.innerHTML = '';
            
            // ALWAYS try to load from GitHub API directly
            try {
                const url = 'https://api.github.com/repos/Euryalus-Kay/aeros-kiosk-github-pages/contents/pdfs?ref=main';
                console.log('📡 Fetching from:', url);
                const res = await fetch(url);
                if (!res.ok) throw new Error('GitHub API error: ' + res.status);
                const items = await res.json();
                console.log('📄 GitHub API response:', items);
                
                // BUILD ALL OPTIONS AT ONCE
                let optionsHTML = '<option value="">Select PDF</option>';
                items.forEach(item => {
                    if (item.name && item.name.toLowerCase().endsWith('.pdf')) {
                        optionsHTML += `<option value="${item.name}">${item.name}</option>`;
                        console.log('✅ Added PDF:', item.name);
                    }
                });
                
                // SET ALL OPTIONS AT ONCE
                select.innerHTML = optionsHTML;
                console.log('🎯 Dropdown updated with', select.options.length, 'options');
                
            } catch (e) {
                console.warn('Could not load PDFs from GitHub:', e.message);
                // Fallback PDFs
                select.innerHTML = '<option value="">Select PDF</option><option value="sample1.pdf">sample1.pdf</option><option value="sample2.pdf">sample2.pdf</option><option value="manual.pdf">manual.pdf</option><option value="guide.pdf">guide.pdf</option>';
            }
        }
        
        async function uploadPDF() {
            const fileInput = document.getElementById('pdfFile');
            const statusDiv = document.getElementById('uploadStatus');
            
            if (!fileInput.files[0]) {
                statusDiv.textContent = 'Please select a PDF file';
                statusDiv.style.color = '#dc3545';
                return;
            }
            
            const file = fileInput.files[0];
            if (!file.name.endsWith('.pdf')) {
                statusDiv.textContent = 'Only PDF files are allowed';
                statusDiv.style.color = '#dc3545';
                return;
            }
            
            try {
                statusDiv.textContent = 'Processing PDF...';
                statusDiv.style.color = '#ffc107';
                
                const hasGithub = config.github && config.github.owner && config.github.repo && config.github.branch && config.github.token;
                if (hasGithub) {
                    statusDiv.textContent = 'Uploading to GitHub...';
                    const arrayBuffer = await file.arrayBuffer();
                    
                    // Convert to base64 without stack overflow
                    const uint8Array = new Uint8Array(arrayBuffer);
                    let binaryString = '';
                    const chunkSize = 8192; // Process in chunks to avoid stack overflow
                    for (let i = 0; i < uint8Array.length; i += chunkSize) {
                        const chunk = uint8Array.slice(i, i + chunkSize);
                        binaryString += String.fromCharCode.apply(null, chunk);
                    }
                    const base64 = btoa(binaryString);
                    
                    const apiUrl = `https://api.github.com/repos/${encodeURIComponent(config.github.owner)}/${encodeURIComponent(config.github.repo)}/contents/pdfs/${encodeURIComponent(file.name)}`;
                    const res = await fetch(apiUrl, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${config.github.token}`,
                            'Accept': 'application/vnd.github+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: `Add ${file.name} via kiosk upload`,
                            content: base64,
                            branch: config.github.branch
                        })
                    });
                    if (!res.ok) {
                        const text = await res.text();
                        throw new Error('GitHub upload failed: ' + res.status + ' ' + text);
                    }
                    statusDiv.textContent = 'Uploaded to GitHub!';
                    statusDiv.style.color = '#28a745';
                    await loadPDFs();
                } else {
                    const fileUrl = URL.createObjectURL(file);
                const select = document.getElementById('pdfSelect');
                select.innerHTML += `<option value="${file.name}">${file.name}</option>`;
                if (!window.uploadedPDFs) window.uploadedPDFs = {};
                window.uploadedPDFs[file.name] = fileUrl;
                    statusDiv.textContent = 'PDF ready to use (session only)';
                statusDiv.style.color = '#28a745';
                    savePersistentData();
                }
                fileInput.value = '';
                
            } catch (error) {
                statusDiv.textContent = 'Upload failed: ' + error.message;
                statusDiv.style.color = '#dc3545';
            }
        }
        
        function switchToProduction() {
            if (!confirm('Switch to Production Mode?\n\nThis is PERMANENT and will:\n• Lock all settings\n• Hide developer options\n• Cannot be undone\n\nAre you sure?')) {
                return;
            }
            
            config.mode = 'production';
            updateUI();
            savePersistentData(); // Save mode change
            alert('Switched to Production Mode');
        }

        // Global error handler to suppress async listener errors
        window.addEventListener('unhandledrejection', function(event) {
            if (event.reason && event.reason.message && 
                event.reason.message.includes('listener indicated an asynchronous response')) {
                console.log('🔇 Suppressed async listener error (likely browser extension)');
                event.preventDefault();
                return;
            }
        });
        
        // Start
        window.onload = init;
    </script>
</body>
</html>
